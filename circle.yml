machine:
  services:
    - docker
  python:
    version: 3.5.2

dependencies:
  cache_directories:
    - "~/docker"
  override:
    - pip3 install -U git+https://github.com/nypublicradio/deploy.git
    - ecs_deploy build

test:
  override:
    - ecs_deploy test --test-cmd='npm test'

deployment:
  prod:
    tag: /v[0-9]+\.[0-9]+\.[0-9]+/
    commands:
      - ecs_deploy deploy --env=prod --memory-reservation=256 --port=8888 --cmd=bin/server --role=web
      - ecs_deploy deploy --env=prod --memory-reservation=256 --port=8888 --cmd=bin/server --role=worker
  demo:
    branch: moberle-SYS-654
    commands:
      - ecs_deploy deploy --env=demo --memory-reservation=128 --port=8888 --cmd=bin/server --role=web
      - ecs_deploy deploy --env=demo --memory-reservation=256 --port=8888 --cmd=bin/server --role=worker
